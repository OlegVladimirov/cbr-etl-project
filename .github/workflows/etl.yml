name: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π ETL —Å –¶–ë –†–§

on:
  schedule:
    - cron: '0 2 * * *' # 02:00 UTC ~ 05:00 –ú–°–ö
  workflow_dispatch:

jobs:
  run-etl:
    runs-on: ubuntu-latest

    steps:
      # 1. –°–∫–∞—á–∞—Ç—å –∫–æ–¥
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      # 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          pip install --upgrade pip
          pip install -r etl/requirements.txt

      # 4.
      - name: üåê –ü–æ–∫–∞–∑–∞—Ç—å IP-–∞–¥—Ä–µ—Å runner'–∞
        run: |
          echo "Public IP: $(curl -s ifconfig.me)"
          echo "GitHub Actions runner IP shown."

      # 5.
      - name: üöß –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å render.com (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ IPv4)
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ render.com —á–µ—Ä–µ–∑ IPv4..."
          # –ü–æ–ª—É—á–∞–µ–º IPv4-–∞–¥—Ä–µ—Å —Ö–æ—Å—Ç–∞
          IP=$(dig +short dpg-d2tj3ser433s73dfifr0-a.oregon-postgres.render.com A | head -n1)
          echo "IPv4-–∞–¥—Ä–µ—Å: $IP"
          if [ -n "$IP" ]; then
            timeout 10s telnet "$IP" 5432 || echo "‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $IP:5432 –Ω–µ —É–¥–∞–ª–æ—Å—å"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑—Ä–µ—à–∏—Ç—å IPv4-–∞–¥—Ä–µ—Å"
          fi

      # 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å ETL-—Å–∫—Ä–∏–ø—Ç
      - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å ETL
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          INIT_LOAD: ${{ secrets.INIT_LOAD }}  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        run: |
          python etl/etl_cbr_exchange_rates.py
